<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ResearchAgent UI Simulation (Visual Grouping & Minimization)</title>
    <style>
        /* css/style.css - Dark Professional Theme - Chat UI Update v2.5.3 - Visual Grouping & Minimization */

        :root {
            --bg-color: #212529;
            --panel-bg: #343A40;
            --panel-bg-lighter: #495057;
            --panel-bg-lightest: #6C757D;
            --border-color: #495057;
            --text-color: #F8F9FA;
            --text-color-muted: #ADB5BD;
            --text-color-darker: #6C757D;
            
            --accent-color: #0D9488; 
            --accent-color-hover: #0F766E;
            --user-message-line-color: #0A6C60; 
            --button-text-on-accent: #FFFFFF;
            
            --error-color: #DC3545;
            --error-color-darker: #B02A37;
            --warning-color: #FFC107;

            --unified-outer-line-blue: #3498DB;

            --agent-line-default-color: #0F766E; 
            --agent-line-system-color: #7F8C8D;      
            --agent-line-intent-classifier-color: #5DADE2; 
            --agent-line-planner-color: #3498DB;         
            --agent-line-controller-color: #E67E22;      
            --agent-line-executor-color: #2ECC71;        
            --agent-line-tool-color: #1ABC9C;            
            --agent-line-evaluator-step-color: #9B59B6;  
            --agent-line-evaluator-overall-color: #8E44AD; 
            --agent-line-warning-color: #F39C12;         
            --agent-line-error-color: #E74C3C;           
            --agent-line-llm-core-color: #6C757D;        

            --log-bg-default: var(--panel-bg);
            --log-border-default: var(--border-color);
            --log-source-system-bg: rgba(127, 140, 141, 0.05);
            --log-source-system-border: var(--agent-line-system-color);
            /* ... other log source colors ... */

            --terminal-bg: #161A1D;
            --terminal-text: #CED4DA;
            --code-bg: var(--terminal-bg); 
            --code-text: var(--terminal-text);
            --pre-bg: #161A1D; 
            --pre-text: #CED4DA;
            --pre-border: #495057;

            --status-idle-color: #198754;
            --status-running-color: #FFC107;
            --status-error-color: #DC3545;
            --status-disconnected-color: #6C757D;

            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            --monospace-font: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;

            --chat-content-max-width: 75%; 
            --user-chat-content-max-width: 65%;
            
            /* Agent Avatar/Label Styling */
            --agent-avatar-bg: var(--agent-line-system-color);
            --agent-avatar-text: var(--bg-color);
            --agent-avatar-size: 28px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-color); font-size: 14px; overflow: hidden; }

        .app-container { display: flex; height: 100vh; }
        .panel { display: flex; flex-direction: column; background-color: var(--panel-bg); overflow: hidden; }
        .panel:not(:last-child) { border-right: 1px solid var(--border-color); }
        .left-panel { flex: 0 0 240px; }
        .center-panel { flex: 1; background-color: var(--bg-color); } 
        .right-panel { flex: 0 0 500px; background-color: var(--terminal-bg); }

        .panel-header, .chat-header, .monitor-header { background-color: var(--panel-bg-lighter); }
        .panel-header, .panel-footer, .chat-header, .monitor-header { padding: 10px 15px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; min-height: 45px; }
        .panel-footer { border-bottom: none; border-top: 1px solid var(--border-color); margin-top: auto; color: var(--text-color-muted); font-size: 0.85em; background-color: var(--panel-bg-lighter); }
        .monitor-header { background-color: var(--terminal-bg); border-bottom-color: var(--border-color); }

        .scrollable-content { flex-grow: 1; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--panel-bg-lightest) var(--panel-bg); }
        .scrollable-content::-webkit-scrollbar { width: 8px; }
        .scrollable-content::-webkit-scrollbar-track { background: var(--panel-bg); }
        .scrollable-content::-webkit-scrollbar-thumb { background-color: var(--panel-bg-lightest); border-radius: 4px; border: 2px solid var(--panel-bg); }

        .new-task-btn { background-color: var(--accent-color); color: var(--button-text-on-accent); border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-weight: 500; font-size: 0.9em; transition: background-color 0.2s ease; }
        .new-task-btn:hover { background-color: var(--accent-color-hover); }
        .task-list { list-style: none; padding: 8px 15px; background-color: var(--panel-bg); }
        .task-item { padding: 10px 0; cursor: pointer; font-size: 0.9em; border-left: 3px solid transparent; transition: background-color 0.2s ease, border-left-color 0.2s ease; display: flex; justify-content: space-between; align-items: center; gap: 5px; margin: 0 -15px; padding-left: 15px; padding-right: 15px; }
        .task-item.active { background-color: var(--panel-bg-lighter); font-weight: 500; color: var(--text-color); border-left-color: var(--accent-color); }
        .task-item:hover { background-color: var(--panel-bg-lightest); }
        .task-item-placeholder { color: var(--text-color-muted); padding: 0.75rem; text-align: center; font-style: italic; }
        .task-title { flex-grow: 1; margin-right: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .task-item-controls { display: flex; align-items: center; gap: 5px; flex-shrink: 0; }
        .task-edit-btn { background: none; border: none; color: var(--text-color-darker); cursor: pointer; font-size: 0.9rem; padding: 0 0.2rem; line-height: 1; opacity: 0; transition: opacity 0.2s ease, color 0.2s ease; }
        .task-item:hover .task-edit-btn, .task-item.active .task-edit-btn { opacity: 0.6; }
        .task-edit-btn:hover { opacity: 1.0; color: var(--accent-color); }
        .task-delete-btn { background: none; border: none; color: var(--text-color-darker); cursor: pointer; font-size: 1rem; padding: 0 0.25rem; line-height: 1; opacity: 0; transition: opacity 0.2s ease, color 0.2s ease; }
        .task-item:hover .task-delete-btn, .task-item.active .task-delete-btn { opacity: 0.6; }
        .task-delete-btn:hover { opacity: 1.0; color: var(--error-color); }

        .chat-header { background-color: var(--panel-bg-lighter); border-bottom: 1px solid var(--border-color); }
        .chat-header h3 { margin: 0; font-size: 1em; font-weight: 500; }
        .chat-messages { padding: 20px; display: flex; flex-direction: column; gap: 5px; background-color: var(--bg-color); }

        .message { margin-bottom: 12px; line-height: 1.5; font-size: 0.95em; word-wrap: break-word; overflow-wrap: break-word; white-space: normal; position: relative; }

        .message-user-wrapper { display: flex; justify-content: flex-end; }
        .message-user {
            background-color: var(--accent-color);
            color: var(--button-text-on-accent);
            padding: 10px 12px 10px 15px; 
            border-radius: 15px 0px 0px 15px; 
            max-width: var(--user-chat-content-max-width); 
            border-right: 3px solid var(--user-message-line-color);
        }

        .message-outer-blue-line {
            padding-left: 10px; 
            border-left: 3px solid var(--unified-outer-line-blue);
            max-width: var(--chat-content-max-width); 
        }
        .message-system-status-content { 
            font-size: 0.9em;
            color: var(--text-color-muted);
            padding: 5px 0px 5px 10px; 
            font-style: italic;
        }
        .message-system-status-content.error-text { 
            color: var(--agent-line-error-color);
            font-weight: 500;
        }
        .message-plan-proposal-content { 
            padding: 5px 0px 5px 10px;
        }
        .plan-proposal-block { 
            background-color: var(--panel-bg-lighter); 
            border: 1px solid var(--border-color);
            padding: 15px;
            margin-top: 10px;
            border-radius: 8px;
        }
        /* ... other plan proposal styles ... */

        .message-agent-final-content-wrapper { /* New wrapper for final agent messages */
            display: flex;
            align-items: flex-start; /* Align avatar and content block */
            gap: 10px; /* Space between avatar and content */
            max-width: var(--chat-content-max-width);
            margin-left: 10px; /* Indent from the blue line */
        }
        .agent-avatar {
            width: var(--agent-avatar-size);
            height: var(--agent-avatar-size);
            border-radius: 50%;
            background-color: var(--agent-avatar-bg);
            color: var(--agent-avatar-text);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            font-weight: bold;
            flex-shrink: 0;
            margin-top: 5px; /* Align with first line of text */
        }
        .message-agent-final-content { 
            background-color: var(--panel-bg); 
            color: var(--text-color);
            padding: 10px 15px;
            border-radius: 0px 15px 15px 15px; 
            /* max-width: calc(100% - 13px); /* Removed, handled by wrapper */
            position: relative; 
            flex-grow: 1; /* Allow content to take available width */
        }
        .message-outer-blue-line > .chat-copy-btn { 
            position: absolute;
            top: 8px; 
            right: 8px; 
            z-index: 10;
            opacity: 0.3;
        }
        .message-outer-blue-line:hover > .chat-copy-btn {
            opacity: 1;
        }


        .message-agent-step {
            margin-bottom: 8px; 
            padding-left: 10px; 
        }
        .message-agent-step .step-title {
            padding-left: 10px; 
            font-weight: bold;
            display: block; 
            margin-bottom: 5px; 
        }

        .sub-content-container {
            margin-top: 5px; 
            padding-left: 15px; 
        }
        .sub-content-container > .message { 
            margin-bottom: 8px;
            max-width: var(--chat-content-max-width); 
        }


        .message-agent-substatus {
            margin-bottom: 5px; 
            padding-left: 10px; 
            border-left-width: 3px;
            border-left-style: solid;
        }
        .message-agent-substatus .content { 
            font-size: 0.8em; 
            color: var(--text-color-darker); 
            padding-left: 10px; 
            font-style: italic;
        }

        .message-agent-thought {
            margin-bottom: 5px;
            padding-left: 0; 
            border-left-width: 3px;
            border-left-style: solid;
        }
        
        .thought-top-row, .tool-output-top-row { /* Combined for consistency */
            display: flex;
            justify-content: space-between;
            align-items: flex-start; 
            padding-left: 10px; 
            margin-bottom: 4px; 
        }
        .message-agent-thought .thought-label, .tool-output-label {
            font-size: 0.9em;
            color: var(--text-color); 
            flex-grow: 1; 
        }
        .tool-output-label strong { color: var(--agent-line-tool-color); }
        .tool-output-label em { color: var(--text-color-muted); font-size: 0.9em; }
        
        .chat-copy-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-color-muted);
            padding: 2px 6px; 
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em; 
            margin-left: 8px; 
            line-height: 1.2; 
            flex-shrink: 0; 
            transition: all 0.2s ease;
        }
        .chat-copy-btn:hover:not(:disabled) {
            background-color: var(--panel-bg-lightest);
            color: var(--text-color);
            border-color: var(--text-color-muted);
        }
        .chat-copy-btn:disabled { opacity: 0.7; cursor: default; }

        .pre-wrapper-with-copy { position: relative; margin: 0.5rem 0; max-width: 100%; }
        .pre-wrapper-with-copy pre { margin-bottom: 0; }
        .pre-wrapper-with-copy .chat-copy-btn { position: absolute; top: 5px; right: 5px; z-index: 10; opacity: 0.3; }
        .pre-wrapper-with-copy:hover .chat-copy-btn { opacity: 1; }

        .message-agent-thought .thought-content-box, 
        .tool-output-content-box { /* Combined for consistency */
            background-color: var(--terminal-bg); 
            color: var(--terminal-text);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.9em;
            white-space: pre-wrap; 
            word-wrap: break-word;
            margin-left: 10px; 
            border: 1px solid var(--pre-border);
            overflow-x: auto; 
        }
        .message-agent-thought .thought-content-box pre,
        .tool-output-content-box pre { 
            margin: 0; padding: 0; background-color: transparent; border: none; color: inherit; font-family: var(--monospace-font);
        }
        .message-agent-thought .thought-content-box code,
        .tool-output-content-box code { 
            background-color: var(--panel-bg-lighter); color: var(--text-color); padding: 0.1em 0.3em; border-radius: 3px;
        }
        .message-agent-thought .thought-content-box pre code,
        .tool-output-content-box pre code { background: none; padding: 0; }

        .message-agent-tool-output {
            margin-bottom: 5px;
            padding-left: 0; 
            border-left-width: 3px;
            border-left-style: solid;
        }
        /* Minimized Tool Output Styling */
        .message-agent-tool-output .tool-output-label.minimized {
            cursor: pointer;
            padding: 5px 10px;
            background-color: var(--panel-bg-lighter);
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }
        .message-agent-tool-output .tool-output-label.minimized:hover {
            background-color: var(--panel-bg-lightest);
        }
        .message-agent-tool-output .tool-output-label.minimized::after {
            content: " (click to expand)";
            font-size: 0.8em;
            color: var(--text-color-muted);
        }
        .message-agent-tool-output .tool-output-content-box,
        .message-agent-tool-output .tool-output-expand-btn,
        .message-agent-tool-output .tool-output-artifact-link,
        .message-agent-tool-output .chat-copy-btn:not(.always-visible) { /* Assuming copy on label is always visible */
            display: none; /* Hidden by default when minimized */
        }
        .message-agent-tool-output.expanded .tool-output-content-box,
        .message-agent-tool-output.expanded .tool-output-expand-btn,
        .message-agent-tool-output.expanded .tool-output-artifact-link,
        .message-agent-tool-output.expanded .chat-copy-btn {
            display: block; /* Or flex, grid as needed */
        }
        .message-agent-tool-output.expanded .tool-output-label.minimized::after {
            content: " (click to collapse)";
        }
        /* Adjust top-row for minimized state if copy button is part of it */
        .message-agent-tool-output .tool-output-top-row {
            /* Default state, copy button might be hidden by the .expanded logic above */
        }
         .message-agent-tool-output.expanded .tool-output-top-row .chat-copy-btn {
            display: inline-block; /* Ensure copy button in top row shows when expanded */
        }


        .tool-output-preview { }
        .tool-output-full { display: none; }

        .tool-output-expand-btn {
            background: none; border: 1px solid var(--border-color); color: var(--text-color-muted);
            padding: 3px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8em;
            margin-top: 8px; margin-left: 10px; transition: all 0.2s ease;
        }
        .tool-output-expand-btn:hover { background-color: var(--panel-bg-lightest); color: var(--text-color); }

        .tool-output-artifact-link {
            font-size: 0.85em; font-style: normal; color: var(--text-color-muted);
            margin-top: 6px; margin-left: 10px; padding: 4px 8px; 
            border: 1px solid var(--border-color); border-radius: 4px;
            display: inline-block; cursor: pointer; transition: all 0.2s ease;
        }
        .tool-output-artifact-link:hover { background-color: var(--panel-bg-lightest); color: var(--text-color); border-color: var(--text-color-muted); }
        .tool-output-artifact-link::before { content: "📄 "; margin-right: 4px; }


        #agent-thinking-status {
            margin-top: 8px; padding: 5px 0px 5px 20px; border-left-width: 3px;
            border-left-style: solid; font-size: 0.9em; color: var(--text-color-muted);
            font-style: italic; display: none; max-width: var(--chat-content-max-width); 
        }

        /* ... (agent line colors, input area, monitor, artifacts, media queries, etc. remain largely the same) ... */
        .agent-line-system { border-left-color: var(--agent-line-system-color) !important; }
        .agent-line-intent-classifier { border-left-color: var(--agent-line-intent-classifier-color) !important; }
        .agent-line-planner { border-left-color: var(--agent-line-planner-color) !important; }
        .agent-line-controller { border-left-color: var(--agent-line-controller-color) !important; }
        .agent-line-executor { border-left-color: var(--agent-line-executor-color) !important; }
        .agent-line-tool { border-left-color: var(--agent-line-tool-color) !important; }
        .agent-line-evaluator-step { border-left-color: var(--agent-line-evaluator-step-color) !important; }
        .agent-line-evaluator-overall { border-left-color: var(--agent-line-evaluator-overall-color) !important; }
        .agent-line-warning { border-left-color: var(--agent-line-warning-color) !important; }
        .agent-line-error { border-left-color: var(--agent-line-error-color) !important; }
        .agent-line-llm-core { border-left-color: var(--agent-line-llm-core-color) !important; }

        .chat-input-area { display: flex; padding: 10px 15px; border-top: 1px solid var(--border-color); background-color: var(--panel-bg-lighter); flex-shrink: 0; align-items: flex-end; }
        .chat-input-area textarea { flex-grow: 1; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 5px; background-color: var(--panel-bg); color: var(--text-color); resize: none; min-height: 38px; max-height: 150px; margin-right: 10px; font-family: inherit; font-size: 0.95em; line-height: 1.4; overflow-y: auto; }
        .chat-input-area textarea:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 1px var(--accent-color); }
        .chat-input-area button { padding: 8px 15px; background-color: var(--accent-color); color: var(--button-text-on-accent); border: none; border-radius: 5px; cursor: pointer; font-weight: 500; height: 38px; transition: background-color 0.2s ease; }
        .chat-input-area button:hover { background-color: var(--accent-color-hover); }

        .monitor-header { background-color: var(--terminal-bg); border-bottom-color: var(--border-color); }
        .monitor-header h3 { margin: 0; font-size: 1em; font-weight: 500; }
        .monitor-controls { display: flex; align-items: center; gap: 10px; }

        .monitor-split-content { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        .monitor-log-area { flex: 1 1 0; overflow-y: auto; padding: 10px 15px; background-color: var(--terminal-bg); font-family: var(--monospace-font); font-size: 0.85em; line-height: 1.5; color: var(--terminal-text); border-bottom: 1px solid var(--border-color); }
        .monitor-artifact-area { flex: 1 1 0; min-height: 100px; padding: 10px 15px; background-color: var(--panel-bg); display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; border-top: 1px solid var(--border-color); overflow: hidden; }
        .artifact-placeholder { color: var(--text-color-darker); font-style: italic; }

        .monitor-log-entry { margin-bottom: 8px; padding: 6px 10px; border-radius: 4px; border: 1px solid var(--log-border-default); background-color: var(--log-bg-default); display: flex; flex-direction: column; border-left-width: 3px; }
        .log-timestamp { font-size: 0.8em; color: var(--text-color-muted); margin-bottom: 4px; white-space: nowrap; }
        .log-content { white-space: pre-wrap; word-wrap: break-word; color: var(--text-color); }
        .log-content pre { background-color: var(--pre-bg); color: var(--pre-text); padding: 5px 8px; margin-top: 4px; border-radius: 3px; border: 1px solid var(--pre-border); overflow-x: auto; white-space: pre-wrap; word-break: break-word; overflow-wrap: break-word; }
        
        /* Log source specific styles */
        .log-source-system, .log-source-system_event { background-color: var(--log-source-system-bg); border-left-color: var(--log-source-system-border) !important; }
        .log-source-tool_deep_research_synthesizer_output, .log-source-tool_write_file_output, .log-source-tool_tavily_search_api_output {
            background-color: var(--log-source-tool-bg); border-left-color: var(--log-source-tool-border) !important;
        }
        .log-source-artifact_generated { background-color: var(--log-source-artifact-bg); border-left-color: var(--log-source-artifact-border) !important; }
        /* Add more specific log source styles here if needed */


        .artifact-filename { flex-shrink: 0; width: 100%; text-align: center; padding: 5px 0; font-size: 0.85em; color: var(--text-color-darker); border-bottom: 1px solid var(--border-color); margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .monitor-artifact-area img, .monitor-artifact-area pre { flex-grow: 1; flex-shrink: 1; min-height: 0; max-width: 100%; max-height: 100%; overflow: auto; border: none; margin-bottom: 5px; border-radius: 4px; }
        .monitor-artifact-area img { object-fit: contain; background-color: #FFFFFF; }
        .monitor-artifact-area pre { width: 100%; padding: 10px; font-family: var(--monospace-font); font-size: 0.9em; color: var(--pre-text); background-color: var(--pre-bg); border: 1px solid var(--pre-border); white-space: pre-wrap; word-break: break-all; }
        .monitor-artifact-area .artifact-error { font-size: 0.9em; font-style: italic; color: var(--error-color); flex-grow: 1; display: flex; align-items: center; justify-content: center; }

        .artifact-nav { display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: auto; width: 100%; flex-shrink: 0; height: 25px; padding-top: 5px; }
        .artifact-nav-btn { background-color: var(--panel-bg-lighter); color: var(--text-color-muted); border: 1px solid var(--border-color); padding: 3px 8px; border-radius: 4px; cursor: pointer; font-size: 0.85em; transition: all 0.2s ease; }
        .artifact-nav-btn:hover:not(:disabled) { background-color: var(--panel-bg-lightest); color: var(--text-color); border-color: var(--text-color-muted); }
        .artifact-nav-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .artifact-counter { font-size: 0.85em; color: var(--text-color-muted); }

        .message pre { 
            background-color: var(--pre-bg); border: 1px solid var(--pre-border); border-radius: 4px;
            padding: 0.75rem; overflow-x: auto; white-space: pre; 
            font-family: var(--monospace-font); font-size: 0.9em; color: var(--pre-text);
        }
        .message code { 
            background-color: var(--code-bg); color: var(--code-text); padding: 0.2em 0.4em;
            margin: 0; font-size: 85%; border-radius: 3px; font-family: var(--monospace-font);
        }
        .message pre code { 
            padding: 0; margin: 0; font-size: inherit; background: none;
            border-radius: 0; color: inherit; white-space: pre; 
        }

        @media (max-width: 768px) {
            .app-container { flex-direction: column; height: auto; min-height: 100vh; }
            .left-panel { flex: 0 0 auto; width: 100%; order: 1; }
            .right-panel { flex: 0 0 auto; width: 100%; order: 3; }
            .center-panel { flex: 1 1 auto; height: auto; min-height: 300px; order: 2; }
            .panel:not(:last-child) { border-right: none; border-bottom: 1px solid var(--border-color); }
            .monitor-artifact-area img, .monitor-artifact-area pre { max-height: 150px; }
            .llm-selector { max-width: 150px; font-size: 0.8em; }
            .monitor-header { flex-wrap: wrap; }
            .monitor-controls { margin-left: auto; padding-top: 5px;}
            :root { 
                --chat-content-max-width: 90%; 
                --user-chat-content-max-width: 80%;
            }
        }
        /* ... (other existing styles for credits, LLM selectors, monitor status, stop button, upload, tokens) ... */
        .app-credits { font-size: 0.9em; text-align: center; padding-top: 5px; opacity: 0.7; }
        .app-credits a { color: var(--text-color-muted); text-decoration: none; }
        .app-credits a:hover { color: var(--text-color); text-decoration: underline; }

        .chat-header-llm-controls { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; flex-grow: 1; justify-content: flex-end; }
        .llm-selector-group { display: flex; flex-direction: column; gap: 2px; }
        .llm-selector-group label { font-size: 0.75em; color: var(--text-color-darker); margin-bottom: 0; white-space: nowrap; }
        .llm-selector, .role-llm-select { background-color: var(--panel-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 4px; padding: 4px 6px; font-size: 0.8em; max-width: 160px; min-width: 120px; cursor: pointer; }
        .llm-selector:focus, .role-llm-select:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 1px var(--accent-color); }
        .llm-selector optgroup, .role-llm-select optgroup { font-weight: bold; font-style: italic; background-color: var(--panel-bg-lighter); color: var(--text-color-muted); }
        .llm-selector option, .role-llm-select option { background-color: var(--panel-bg); color: var(--text-color); }

        .monitor-status-container { display: flex; align-items: center; gap: 6px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; background-color: grey; transition: background-color 0.3s ease; }
        .status-dot.idle { background-color: var(--status-idle-color); }
        .status-dot.running { background-color: var(--status-running-color); }
        .status-dot.error { background-color: var(--status-error-color); }
        .status-dot.disconnected { background-color: var(--status-disconnected-color); }
        .monitor-status-text { font-size: 0.85em; color: var(--text-color-darker); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .stop-button { background-color: var(--error-color); color: white; border: none; border-radius: 4px; padding: 2px 8px; font-size: 0.8em; font-weight: bold; cursor: pointer; margin-left: 10px; display: none; transition: background-color 0.2s ease, opacity 0.2s ease; line-height: 1.5; }
        .stop-button:hover:not(:disabled) { background-color: var(--error-color-darker); }
        .stop-button:disabled { background-color: #9E9E9E; cursor: not-allowed; opacity: 0.6; }

        .upload-area { padding: 10px 15px; border-top: 1px solid var(--border-color); background-color: var(--panel-bg-lighter); flex-shrink: 0; text-align: center; }
        .upload-button { background-color: var(--panel-bg); color: var(--text-color-muted); border: 1px solid var(--border-color); padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.85em; transition: all 0.2s ease; }
        .upload-button:hover:not(:disabled) { background-color: var(--panel-bg-lightest); color: var(--text-color); border-color: var(--text-color-muted); }
        .upload-button:disabled { opacity: 0.5; cursor: not-allowed; }

        .token-usage-area { 
            padding: 0; border-top: 1px solid var(--border-color); background-color: var(--panel-bg); 
            flex-shrink: 0; font-size: 0.8em; color: var(--text-color-muted); 
        }
        .token-usage-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 6px 15px; cursor: pointer; border-bottom: 1px solid transparent; 
            transition: background-color 0.2s ease;
        }
        .token-usage-header:hover { background-color: var(--panel-bg-lighter); }
        .token-usage-area .token-label { font-weight: 500; color: var(--text-color-darker); margin-right: 5px; }
        #task-total-tokens-overall { font-weight: bold; color: var(--text-color); margin-right: 5px; }
        .token-expand-btn {
            background: none; border: none; color: var(--text-color-muted); cursor: pointer;
            font-size: 0.9em; padding: 2px 4px; margin-left: auto; border-radius: 3px; line-height: 1;
        }
        .token-expand-btn:hover { color: var(--text-color); background-color: var(--panel-bg-lightest); }
        .token-usage-details {
            padding: 8px 15px; border-top: 1px solid var(--border-color); background-color: var(--panel-bg); 
        }
        .token-usage-details p { margin: 3px 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.95em; }
        .role-token-breakdown { margin-top: 6px; padding-top: 6px; border-top: 1px dashed var(--panel-bg-lighter); }
        .role-token-entry { 
            display: flex; flex-direction: column; margin-bottom: 4px !important; 
            padding-bottom: 2px; border-bottom: 1px solid var(--panel-bg-lighter); 
        }
        .role-token-entry:last-child { border-bottom: none; margin-bottom: 0 !important; }
        .token-label-role { 
            font-weight: bold; color: var(--text-color-muted); margin-right: 5px;
            display: block; font-size: 0.9em; margin-bottom: 2px;
        }
        .role-token-values {
            display: grid; grid-template-columns: auto 1fr; gap: 0px 8px; 
            padding-left: 10px; font-size: 0.9em;
        }
        .token-value-item { display: contents; }
        .token-value-item .token-sublabel { color: var(--text-color-darker); text-align: right; padding-right: 5px; }
        .token-value-item:not(.total) span:not(.token-sublabel) { color: var(--text-color); text-align: left; }
        .token-value-item.total span:not(.token-sublabel) { color: var(--text-color); font-weight: bold; text-align: left; }

    </style>
</head>
<body>
    <div class="app-container">
        <nav class="panel left-panel">
            <div class="panel-header"><button id="new-task-button" class="new-task-btn">+ New Task</button></div>
            <ul id="task-list" class="task-list scrollable-content">
                <li class="task-item active" data-task-id="task-1"><span class="task-title" title="Deep Dive into LLMs & Bioinformatics">Deep Dive into LLMs & Bio...</span><div class="task-item-controls"><button class="task-edit-btn" title="Rename Task">✏️</button><button class="task-delete-btn" title="Delete Task">🗑️</button></div></li>
                <li class="task-item" data-task-id="task-2"><span class="task-title" title="Analyze Protein Folding Data">Analyze Protein Folding Data</span><div class="task-item-controls"><button class="task-edit-btn" title="Rename Task">✏️</button><button class="task-delete-btn" title="Delete Task">🗑️</button></div></li>
            </ul>
            <div id="token-usage-area" class="token-usage-area">
                <div id="token-usage-header" class="token-usage-header"><span class="token-label">Task Tokens:</span><span id="task-total-tokens-overall">15670</span><button id="token-expand-btn" class="token-expand-btn" title="Show Details">[+]</button></div>
                <div id="token-usage-details" class="token-usage-details" style="display: none;"><p><span class="token-label">Last Call:</span> <span id="last-call-tokens">Eval - gemini-pro: In: 300, Out: 50, Total: 350</span></p><div id="role-token-breakdown" class="role-token-breakdown"><p class="role-token-entry"><span class="token-label-role">Planner:</span> <span class="role-token-values"><span class="token-value-item"><span class="token-sublabel">In:</span> 250</span><span class="token-value-item"><span class="token-sublabel">Out:</span> 500</span><span class="token-value-item total"><span class="token-sublabel">Total:</span> 750</span></span></p></div></div>
            </div>
            <div class="upload-area"><input type="file" id="file-upload-input" multiple style="display: none;"><button id="upload-file-button" class="upload-button" title="Upload files to current task workspace">Upload File(s)</button></div>
            <div class="panel-footer"><div class="app-credits">ResearchAgent<br><span style="font-size: 0.9em;">Developed by Valerio Bianchi &amp; Gemini</span></div></div>
        </nav>

        <main class="panel center-panel">
            <div class="panel-header chat-header">
                <h3 id="current-task-title">Deep Dive into LLMs & Bioinformatics</h3>
                <div class="chat-header-llm-controls"> </div>
            </div>
            <div id="chat-messages" class="chat-messages scrollable-content">
                <div class="message message-user-wrapper">
                    <div class="message-user">Make a deep research over bioinformatics and LLMs. Then save it in a file called summary.txt. Show me in the end a 3 bullet point summary of it.</div>
                </div>

                <div class="message message-agent-step">
                    <div class="step-title"><strong>Step 1/5: Perform an in-depth research investigation on the topic of 'bioinformatics and LLMs' to gather comprehensive information.</strong></div>
                    <div class="sub-content-container">
                        <div class="message message-agent-substatus agent-line-controller"><div class="content">Controller: Validating step, preparing `deep_research_synthesizer`...</div></div>
                        <div class="message message-agent-thought agent-line-controller">
                            <div class="thought-top-row"><div class="thought-label">Controller thought:</div><button class="chat-copy-btn" title="Copy to clipboard">📋&nbsp;Copy</button></div>
                            <div class="thought-content-box">The planner suggested `deep_research_synthesizer` and it perfectly aligns...</div>
                        </div>
                        <div class="message message-agent-substatus agent-line-executor"><div class="content">Executor: Using `deep_research_synthesizer`...</div></div>
                        <div class="message message-agent-tool-output agent-line-tool" onclick="this.classList.toggle('expanded')">
                            <div class="tool-output-top-row">
                                <div class="tool-output-label minimized">Tool Output: <strong>tavily_search_api</strong> (Input: <em>bioinformatics and LLMs...</em>)</div>
                                <button class="chat-copy-btn always-visible" title="Copy to clipboard">📋&nbsp;Copy</button> 
                            </div>
                            <div class="tool-output-content-box"><div class="tool-output-preview">Search results preview...</div><div class="tool-output-full">Full search results...</div></div>
                            <button class="tool-output-expand-btn">Expand</button>
                        </div>
                        <div class="message message-agent-tool-output agent-line-tool" onclick="this.classList.toggle('expanded')">
                            <div class="tool-output-top-row">
                                <div class="tool-output-label minimized">Tool Output: <strong>deep_research_synthesizer</strong> (Input: <em>N/A</em>)</div>
                                <button class="chat-copy-btn always-visible" title="Copy to clipboard">📋&nbsp;Copy</button>
                            </div>
                            <div class="tool-output-content-box"><div class="tool-output-preview">Report preview...</div><div class="tool-output-full">Full report content...</div></div>
                            <button class="tool-output-expand-btn">Expand</button>
                        </div>
                        <div class="message message-agent-substatus agent-line-evaluator-step"><div class="content">Evaluator: Step 1 successful. Report generated.</div></div>
                    </div>
                </div>

                <div class="message message-agent-step">
                    <div class="step-title"><strong>Step 2/5: Summarize the comprehensive research report...</strong></div>
                     <div class="sub-content-container">
                        <div class="message message-agent-thought agent-line-controller">
                            <div class="thought-top-row"><div class="thought-label">Controller thought:</div><button class="chat-copy-btn" title="Copy to clipboard">📋&nbsp;Copy</button></div>
                            <div class="thought-content-box">The previous step generated the report. Now, the LLM needs to summarize it. No specific tool needed for summarization itself.</div>
                        </div>
                        <div class="message message-agent-substatus agent-line-executor"><div class="content">Executor: Generating summary via LLM...</div></div>
                        </div>
                </div>
                 <div class="message message-agent-step">
                    <div class="step-title"><strong>Step 3/5: Save the generated summary into a file named 'summary.txt'...</strong></div>
                     <div class="sub-content-container">
                        <div class="message message-agent-tool-output agent-line-tool" onclick="this.classList.toggle('expanded')">
                            <div class="tool-output-top-row">
                                <div class="tool-output-label minimized">Tool Output: <strong>write_file</strong> (Input: <em>summary.txt...</em>)</div>
                                <button class="chat-copy-btn always-visible" title="Copy to clipboard">📋&nbsp;Copy</button>
                            </div>
                            <div class="tool-output-content-box">File 'summary.txt' written successfully to workspace.</div>
                            <div class="tool-output-artifact-link" title="View summary.txt in Artifacts">📄 References artifact: summary.txt</div>
                        </div>
                    </div>
                </div>

                <div class="message message-outer-blue-line">
                    <button class="chat-copy-btn" title="Copy to clipboard">📋&nbsp;Copy</button>
                    <div class="message-agent-final-content-wrapper">
                        <div class="agent-avatar">RA</div>
                        <div class="message-agent-final-content">
                            The deep research on bioinformatics and LLMs has been completed, and the findings have been saved to 'summary.txt'. Here is the 3-bullet point summary you requested:
                            <ul>
                                <li>LLMs are revolutionizing bioinformatics by enabling advanced analysis of complex biological data, including genomic and proteomic sequences.</li>
                                <li>Key applications include accelerating drug discovery, improving disease diagnosis through pattern recognition, and personalizing medicine.</li>
                                <li>Despite their potential, challenges such as data privacy, model interpretability, and the need for specialized training data (BioLMs) are active areas of research.</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div id="agent-thinking-status" class="message agent-thinking-status agent-line-system" style="display: block;">Idle.</div>
            </div>
            <div class="chat-input-area">
                <textarea placeholder="Type your message here..."></textarea>
                <button>Send</button>
            </div>
        </main>

        <aside class="panel right-panel">
            <div class="panel-header monitor-header"><h3>Agent Workspace</h3><div class="monitor-controls"><div id="monitor-status-container" class="monitor-status-container"><span id="status-dot" class="status-dot idle"></span><span id="monitor-status-text" class="monitor-status-text">Idle</span></div><button id="stop-button" class="stop-button" style="display: none;">STOP</button></div></div>
            <div class="monitor-split-content"><div id="monitor-log-area" class="monitor-log-area scrollable-content"><div class="monitor-log-entry log-source-system_event"><span class="log-timestamp">[timestamp]</span><span class="log-content">[SYSTEM_EVENT] Context Switched.</span></div></div><div id="monitor-artifact-area" class="monitor-artifact-area"><div class="artifact-filename">summary.txt</div><pre>Research summary content...</pre><div class="artifact-nav"><button id="artifact-prev-btn" class="artifact-nav-btn" disabled>&lt; Prev</button><span id="artifact-counter" class="artifact-counter">Artifact 1 of 1</span><button id="artifact-next-btn" class="artifact-nav-btn" disabled>Next &gt;</button></div></div></div>
        </aside>
    </div>
    <script>
        // Minimal JS for Expand/Collapse and Copy Button visual feedback for simulation
        document.addEventListener('DOMContentLoaded', () => {
            // Expand/Collapse for Tool Outputs (minimized by default)
            document.querySelectorAll('.message-agent-tool-output').forEach(toolMessage => {
                const label = toolMessage.querySelector('.tool-output-label.minimized');
                const contentBox = toolMessage.querySelector('.tool-output-content-box');
                const expandBtn = toolMessage.querySelector('.tool-output-expand-btn'); // For internal long content
                const artifactLink = toolMessage.querySelector('.tool-output-artifact-link');
                const copyBtnInTopRow = toolMessage.querySelector('.tool-output-top-row .chat-copy-btn');


                if (label && contentBox) { // Ensure primary elements for minimized view exist
                    // Initially hide content and specific buttons if they exist
                    if(contentBox) contentBox.style.display = 'none';
                    if(expandBtn) expandBtn.style.display = 'none';
                    if(artifactLink) artifactLink.style.display = 'none';
                    // Copy button in top row might be always visible or toggle with expansion
                    // For now, let's assume it's always visible if present in top row.

                    label.onclick = (e) => {
                        e.stopPropagation();
                        const isExpanded = toolMessage.classList.toggle('expanded');
                        if (contentBox) contentBox.style.display = isExpanded ? 'block' : 'none';
                        if (expandBtn) expandBtn.style.display = isExpanded ? 'block' : 'none'; // Show internal expand if main is expanded
                        if (artifactLink) artifactLink.style.display = isExpanded ? 'block' : 'none';
                        
                        // If the internal expand button is used, it handles its own text
                        if (expandBtn && expandBtn.textContent === 'Collapse' && !isExpanded) {
                             // If we are collapsing the main tool output, also collapse internal content
                            const fullDiv = contentBox.querySelector('.tool-output-full');
                            const previewDiv = contentBox.querySelector('.tool-output-preview');
                            if(fullDiv && previewDiv) {
                                fullDiv.style.display = 'none';
                                previewDiv.style.display = 'block';
                                expandBtn.textContent = 'Expand';
                            }
                        }
                    };
                }
                // Internal expand/collapse for very long content (if present)
                if(expandBtn && contentBox) {
                    expandBtn.onclick = (e) => {
                        e.stopPropagation();
                        const fullDiv = contentBox.querySelector('.tool-output-full');
                        const previewDiv = contentBox.querySelector('.tool-output-preview');
                        if (fullDiv && previewDiv) {
                            const isContentExpanded = fullDiv.style.display === 'block';
                            fullDiv.style.display = isContentExpanded ? 'none' : 'block';
                            previewDiv.style.display = isContentExpanded ? 'block' : 'none';
                            expandBtn.textContent = isContentExpanded ? 'Expand' : 'Collapse';
                        }
                    };
                }
            });

            // Expand/Collapse for Plan Details
            document.querySelectorAll('.plan-toggle-details-btn').forEach(button => {
                button.onclick = (e) => {
                    e.stopPropagation();
                    const planBlock = button.closest('.plan-proposal-block');
                    const detailsDiv = planBlock.querySelector('.plan-steps-details');
                    if (detailsDiv) {
                        const isHidden = detailsDiv.style.display === 'none';
                        detailsDiv.style.display = isHidden ? 'block' : 'none';
                        button.textContent = isHidden ? 'Hide Details' : 'View Details';
                    }
                };
            });
            
            // Simulated Copy Button Feedback
            document.querySelectorAll('.chat-copy-btn').forEach(button => {
                button.onclick = (e) => {
                    e.stopPropagation();
                    const originalText = button.innerHTML;
                    button.innerHTML = 'Copied ✓';
                    button.disabled = true;
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.disabled = false;
                    }, 1500);
                };
            });
        });
    </script>
</body>
</html>
